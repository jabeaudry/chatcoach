<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.4.1/css/simple-line-icons.css" />
	<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@200&display=swap" rel="stylesheet" />
	<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils_3d/control_utils_3d.js"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
</head>

<body>
	<div class="container">
		<h1>Title</h1>
		<video class="input_video"></video>
		<canvas class="output_canvas" width="680px" height="382.5px"></canvas>
		<div class="landmark-grid-container"></div>
	</div>
	<script type="module">
		const videoElement = document.getElementsByClassName('input_video')[0];
		const canvasElement = document.getElementsByClassName('output_canvas')[0];
		const canvasCtx = canvasElement.getContext('2d');
		const landmarkContainer = document.getElementsByClassName('landmark-grid-container')[0];
		const grid = new LandmarkGrid(landmarkContainer);

		function onResults(results) {
			if (!results.poseLandmarks) {
				grid.updateLandmarks([]);
				return;
			}

			canvasCtx.save();
			canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
			canvasCtx.drawImage(results.segmentationMask, 0, 0,
				canvasElement.width, canvasElement.height);

			// Only overwrite existing pixels.
			canvasCtx.globalCompositeOperation = 'source-in';
			canvasCtx.fillStyle = 'rgba(255,255,255,0)';
			canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);

			// Only overwrite missing pixels.
			canvasCtx.globalCompositeOperation = 'destination-atop';
			canvasCtx.drawImage(
				results.image, 0, 0, canvasElement.width, canvasElement.height);

			canvasCtx.globalCompositeOperation = 'source-over';
			drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
				{ color: 'rgba(237,230,242,0.7)', lineWidth: 3 });
			drawLandmarks(canvasCtx, results.poseLandmarks,
				{ color: 'rgba(237,230,242,0.4)', lineWidth: 1 });
			canvasCtx.restore();
			grid.updateLandmarks(results.poseWorldLandmarks);
			console.log(grid)
		}

		const pose = new Pose({
			locateFile: (file) => {
				return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
			}
		});
		pose.setOptions({
			modelComplexity: 1,
			smoothLandmarks: true,
			enableSegmentation: true,
			smoothSegmentation: true,
			minDetectionConfidence: 0.5,
			minTrackingConfidence: 0.5
		});
		pose.onResults(onResults);

		const camera = new Camera(videoElement, {
			onFrame: async () => {
				await pose.send({ image: videoElement });
			},
			width: 720,
			height: 405
		});
		camera.start();
	</script>
</body>

</html>